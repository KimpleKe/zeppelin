{"paragraphs":[{"text":"%md\n## Feature extraction Notebook\n### Data Loading and schema exploration","dateUpdated":"2017-01-09T06:10:34+0000","config":{"colWidth":12,"graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true,"editorMode":"ace/mode/markdown"},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1483922375963_1970890268","id":"20170109-003935_1992752659","result":{"code":"SUCCESS","type":"HTML","msg":"<h2>Feature extraction Notebook</h2>\n<h3>Data Loading and schema exploration</h3>\n"},"dateCreated":"2017-01-09T00:39:35+0000","dateStarted":"2017-01-09T06:10:34+0000","dateFinished":"2017-01-09T06:10:34+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:90"},{"text":"%spark\nimport org.apache.spark.sql._\n\ndef loadDF(path:String)={\n    val df = spark.read.option(\"header\",\"true\").csv(s\"${path}\")\n    df.cache\n    df.printSchema\n    println(df.count)\n    println(df.first)\n    df \n}\nval basicDF = loadDF(\"s3://rea-consumer-data-qa/ben-kuai/filtered/mobappbasic\")\n","dateUpdated":"2017-01-09T02:31:49+0000","config":{"colWidth":12,"graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true,"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1483923504688_34455632","id":"20170109-005824_271873433","result":{"code":"SUCCESS","type":"TEXT","msg":"\nimport org.apache.spark.sql._\n\nloadDF: (path: String)org.apache.spark.sql.DataFrame\nroot\n |-- Visitor_ID: string (nullable = true)\n |-- Date: string (nullable = true)\n |-- My Rea ID (evar54): string (nullable = true)\n |-- My Rea ID Anon (evar58): string (nullable = true)\n |-- Site (c) (evar24): string (nullable = true)\n |-- Site Section (c) (evar16): string (nullable = true)\n |-- Claim My Property (event28): string (nullable = true)\n |-- Connections Lead (event26): string (nullable = true)\n |-- Get Directions Click (event51): string (nullable = true)\n |-- Live Chat (event86): string (nullable = true)\n |-- New User Registration (event3): string (nullable = true)\n |-- Note Saved to My REA (event65): string (nullable = true)\n |-- Phone No. Reveal - Click (event17): string (nullable = true)\n |-- Print Page / Download PDF (event58): string (nullable = true)\n |-- Prop Details - click map to interact (event33): string (nullable = true)\n |-- Property Details Carousel Click (event60): string (nullable = true)\n |-- Property Saved to My Realestate (event62): string (nullable = true)\n |-- Save Inspection Times to Calendar (event64): string (nullable = true)\n |-- Auction Time Saved to Calendar (event66): string (nullable = true)\n |-- Saved Search (event41): string (nullable = true)\n |-- Search Result â€“ Successful (event4): string (nullable = true)\n |-- Search Result Carousel Click (event35): string (nullable = true)\n |-- Street View Click (event52): string (nullable = true)\n |-- Email Lead to Agent (event1): string (nullable = true)\n |-- Email sent to a Friend (event8): string (nullable = true)\n |-- Share on Social Media (event16): string (nullable = true)\n |-- Share via SMS (event87): string (nullable = true)\n |-- Survey Submitted (event100): string (nullable = true)\n |-- SMS Agent (event111): string (nullable = true)\n |-- Vendor Lead (event91): string (nullable = true)\n |-- View Floor Plan (event54): string (nullable = true)\n |-- Watch Property Video Click (event40): string (nullable = true)\n |-- Click to Apply for Property Online (event13): string (nullable = true)\n |-- 3D Tour (event101): string (nullable = true)\n |-- Save Agent Contact Details (event57): string (nullable = true)\n |-- Property Map Flyout - Premiere (event42): string (nullable = true)\n |-- Property Map Flyout - Featured (event43): string (nullable = true)\n |-- Property Map Flyout - Platinum (event44): string (nullable = true)\n |-- Property Map Flyout - Standard (event45): string (nullable = true)\n |-- Click through to Agent Website (event2): string (nullable = true)\n |-- Page Views: string (nullable = true)\n |-- Property Views (event7): string (nullable = true)\n |-- Visits: string (nullable = true)\n |-- Total Seconds Spent: string (nullable = true)\n |-- app_date: string (nullable = true)\n |-- buy: string (nullable = true)\n |-- rent: string (nullable = true)\n |-- sell: string (nullable = true)\n\n1247465\n[1000334786_108469056,November 17, 2016,null,null,null,other,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,2016-10-18,0,1,0]\n\nbasicDF: org.apache.spark.sql.DataFrame = [Visitor_ID: string, Date: string ... 46 more fields]\n"},"dateCreated":"2017-01-09T00:58:24+0000","dateStarted":"2017-01-09T02:31:49+0000","dateFinished":"2017-01-09T02:32:09+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:91"},{"text":"%md\n##Data window aggregation","dateUpdated":"2017-01-09T04:24:52+0000","config":{"colWidth":12,"graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true,"editorMode":"ace/mode/markdown"},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1483935871624_1891961125","id":"20170109-042431_1743554694","result":{"code":"SUCCESS","type":"HTML","msg":"<h2>Data window aggregation</h2>\n"},"dateCreated":"2017-01-09T04:24:31+0000","dateStarted":"2017-01-09T04:24:52+0000","dateFinished":"2017-01-09T04:24:52+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:92"},{"text":"%spark\n// We only take behaviour where there are at least 3 page views\nbasicDF.where(\"`Page Views` > 3\")","dateUpdated":"2017-01-09T06:15:57+0000","config":{"colWidth":12,"graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true,"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1483936261928_1068782369","id":"20170109-043101_1458751611","result":{"code":"SUCCESS","type":"TEXT","msg":"\nres19: org.apache.spark.sql.Dataset[org.apache.spark.sql.Row] = [Visitor_ID: string, Date: string ... 46 more fields]\n"},"dateCreated":"2017-01-09T04:31:01+0000","dateStarted":"2017-01-09T04:37:10+0000","dateFinished":"2017-01-09T04:37:10+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:93"},{"text":"basicDF.count","dateUpdated":"2017-01-09T04:37:32+0000","config":{"colWidth":12,"graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true,"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1483936344079_-203274116","id":"20170109-043224_470854973","result":{"code":"SUCCESS","type":"TEXT","msg":"\nres21: Long = 1247465\n"},"dateCreated":"2017-01-09T04:32:24+0000","dateStarted":"2017-01-09T04:37:32+0000","dateFinished":"2017-01-09T04:37:33+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:94"},{"text":"// We need to: \n// - Cast the \"Date\" string to a date\n// - Create a column with the date difference between the app_date and the interaction date.\n//   We use this column later to get the latest 3 days of interaction\nval pageViewDF = res19\nval threedaysDF = pageViewDF.withColumn(\"Date\", to_date(unix_timestamp($\"Date\", \"MMMM dd, yyyy\")\n                      .cast(\"timestamp\")))\n                      .withColumn(\"date_diff\", datediff($\"Date\", $\"app_date\"))\n                      .where(\"date_diff < 3\")\n                      \n","dateUpdated":"2017-01-10T00:32:35+0000","config":{"colWidth":12,"graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true,"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1483936662123_19124951","id":"20170109-043742_235970408","result":{"code":"SUCCESS","type":"TEXT","msg":"\npageViewDF: org.apache.spark.sql.Dataset[org.apache.spark.sql.Row] = [Visitor_ID: string, Date: string ... 46 more fields]\n\nthreedaysDF: org.apache.spark.sql.Dataset[org.apache.spark.sql.Row] = [Visitor_ID: string, Date: date ... 47 more fields]\n"},"dateCreated":"2017-01-09T04:37:42+0000","dateStarted":"2017-01-10T00:32:35+0000","dateFinished":"2017-01-10T00:32:38+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:95"},{"text":"// Let's see what we have so far...\nthreedaysDF.select(\"Visitor_ID\", \"Date\", \"date_diff\", \"Site Section (c) (evar16)\", \"Page Views\", \"buy\", \"rent\").orderBy($\"Visitor_id\", $\"Site Section (c) (evar16)\", $\"Date\").show\n","dateUpdated":"2017-01-09T07:11:30+0000","config":{"colWidth":12,"graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true,"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1483937432728_-585215403","id":"20170109-045032_1164579696","result":{"code":"SUCCESS","type":"TEXT","msg":"+--------------------+----------+---------+-------------------------+----------+---+----+\n|          Visitor_ID|      Date|date_diff|Site Section (c) (evar16)|Page Views|buy|rent|\n+--------------------+----------+---------+-------------------------+----------+---+----+\n|31674612840763245...|2016-09-27|        0|                   my rea|         5|  1|   0|\n|31674612840763245...|2016-09-29|        2|                   my rea|        10|  1|   0|\n|31674612840763245...|2016-09-27|        0|                     p4ep|         9|  1|   0|\n|31675608994003158...|2016-09-29|        1|                   my rea|         5|  0|   1|\n|31675608994003158...|2016-09-30|        2|                   my rea|        11|  0|   1|\n|31675608994003158...|2016-09-29|        1|                    other|        10|  0|   1|\n|31675608994003158...|2016-09-30|        2|                    other|         8|  0|   1|\n|31675608994003158...|2016-09-28|        0|                     rent|        28|  0|   1|\n|31675608994003158...|2016-09-28|        0|                     rent|       151|  0|   1|\n|31675608994003158...|2016-09-29|        1|                     rent|       164|  0|   1|\n|31675608994003158...|2016-09-30|        2|                     rent|       168|  0|   1|\n+--------------------+----------+---------+-------------------------+----------+---+----+\n\n"},"dateCreated":"2017-01-09T04:50:32+0000","dateStarted":"2017-01-09T07:11:30+0000","dateFinished":"2017-01-09T07:11:31+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:96"},{"text":"%md\n### Feature extraction","dateUpdated":"2017-01-09T06:20:00+0000","config":{"colWidth":12,"graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true,"editorMode":"ace/mode/markdown"},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1483938629652_-1704144591","id":"20170109-051029_77949037","result":{"code":"SUCCESS","type":"HTML","msg":"<h3>Feature extraction</h3>\n"},"dateCreated":"2017-01-09T05:10:29+0000","dateStarted":"2017-01-09T06:20:00+0000","dateFinished":"2017-01-09T06:20:00+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:97"},{"text":"val siteSectionNames = Array(\"buy\", \"rent\")\nval siteSections = siteSectionNames.map(r => col(r.asInstanceOf[String]))\n\nval distRent = threedaysDF.where(\"rent > 0\")\n          .groupBy($\"Visitor_Id\").pivot(\"Site Section (c) (evar16)\")\n          .agg(sum(\"Page Views\"))\n          .na.fill(0, siteSectionNames.map(_.asInstanceOf[String]))\n          .withColumn(\"totalViews\", siteSections.reduce(_ + _))\n          .where(\"totalViews > 0\")\n          .withColumn(\"rent_prop\", col(\"rent\") / col(\"totalViews\"))\n          .select($\"rent_prop\")\n          .rdd\n          .map {\n              case Row(rent_prop: Double) =>\n                rent_prop\n          }.histogram(20)\n","dateUpdated":"2017-01-10T05:35:43+0000","config":{"colWidth":12,"graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true,"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1483942810529_-2115096408","id":"20170109-062010_780731145","result":{"code":"SUCCESS","type":"TEXT","msg":"\nsiteSectionNames: Array[String] = Array(buy, rent)\n\nsiteSections: Array[org.apache.spark.sql.Column] = Array(buy, rent)\n\nres642: (Array[Double], Array[Long]) = (Array(0.0, 0.05, 0.1, 0.15, 0.2, 0.25, 0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95, 1.0),Array(367, 20, 12, 12, 23, 31, 20, 30, 33, 21, 54, 29, 57, 46, 68, 81, 136, 191, 323, 8302))\n"},"dateCreated":"2017-01-09T06:20:10+0000","dateStarted":"2017-01-10T05:35:43+0000","dateFinished":"2017-01-10T05:33:27+0000","status":"ABORT","progressUpdateIntervalMs":500,"$$hashKey":"object:98"},{"text":"sc.parallelize(distRent(1) zip distRent(0)).toDF.createOrReplaceTempView(\"rent_distribution\")","dateUpdated":"2017-01-10T05:35:36+0000","config":{"colWidth":12,"graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true,"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1484026436035_-1695105479","id":"20170110-053356_1522266657","result":{"code":"ERROR","type":"TEXT","msg":"\n\n\n<console>:146: error: not found: value distRent\n       sc.parallelize(distRent(1) zip distRent(0)).toDF.createOrReplaceTempView(\"rent_distribution\")\n                      ^\n\n\n\n<console>:146: error: not found: value distRent\n       sc.parallelize(distRent(1) zip distRent(0)).toDF.createOrReplaceTempView(\"rent_distribution\")\n                                      ^\n"},"dateCreated":"2017-01-10T05:33:56+0000","dateStarted":"2017-01-10T05:35:36+0000","dateFinished":"2017-01-10T05:35:37+0000","status":"ERROR","progressUpdateIntervalMs":500,"$$hashKey":"object:99"},{"text":"threedaysDF.where(\"buy > 0\")\n           .groupBy($\"Visitor_Id\").pivot(\"Site Section (c) (evar16)\")\n           .agg(sum(\"Page Views\"))\n           .na.fill(0, siteSectionNames.map(_.asInstanceOf[String]))\n           .withColumn(\"totalViews\", siteSections.reduce(_ + _))\n           .withColumn(\"buy_prop\", col(\"buy\") / col(\"totalViews\"))\n           .select($\"Visitor_id\", $\"buy_prop\")\n           .where(\"buy > 0\").select($\"buy_prop\")\n           .rdd\n           .map {\n               case Row(buy_prop: Double) =>\n                buy_prop\n           }.histogram(20)","dateUpdated":"2017-01-10T05:11:28+0000","config":{"colWidth":12,"graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true,"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1484007974035_-798686596","id":"20170110-002614_1294773460","result":{"code":"SUCCESS","type":"TEXT","msg":"\nhistogramBuy: (Array[Double], Array[Long]) = (Array(0.006756756756756757, 0.05641891891891892, 0.10608108108108108, 0.15574324324324323, 0.20540540540540542, 0.25506756756756754, 0.3047297297297297, 0.35439189189189185, 0.40405405405405403, 0.4537162162162162, 0.5033783783783784, 0.5530405405405405, 0.6027027027027028, 0.6523648648648649, 0.702027027027027, 0.7516891891891891, 0.8013513513513514, 0.8510135135135135, 0.9006756756756757, 0.9503378378378379, 1.0),Array(70, 77, 46, 41, 45, 42, 33, 40, 32, 30, 34, 25, 20, 20, 26, 16, 17, 19, 24, 307))\n"},"dateCreated":"2017-01-10T00:26:14+0000","dateStarted":"2017-01-10T04:34:02+0000","dateFinished":"2017-01-10T04:34:13+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:100"},{"text":"sc.parallelize(histogramBuy._2).toDF","dateUpdated":"2017-01-10T04:20:26+0000","config":{"colWidth":12,"graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true,"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1484021954370_-225939300","id":"20170110-041914_1288016244","result":{"code":"SUCCESS","type":"TEXT","msg":"\nres543: Array[Long] = Array(22, 24, 16, 14, 20, 24, 21, 20, 29, 32, 28, 34, 38, 36, 42, 44, 45, 53, 75, 5978)\n"},"dateCreated":"2017-01-10T04:19:14+0000","dateStarted":"2017-01-10T04:19:44+0000","dateFinished":"2017-01-10T04:19:53+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:101"},{"text":"val histRage = (0 to 20).map(_ * 0.05)","dateUpdated":"2017-01-10T04:26:52+0000","config":{"colWidth":12,"graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true,"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1484021975762_1656499151","id":"20170110-041935_328344922","result":{"code":"SUCCESS","type":"TEXT","msg":"\nhistRage: scala.collection.immutable.IndexedSeq[Double] = Vector(0.0, 0.05, 0.1, 0.15000000000000002, 0.2, 0.25, 0.30000000000000004, 0.35000000000000003, 0.4, 0.45, 0.5, 0.55, 0.6000000000000001, 0.65, 0.7000000000000001, 0.75, 0.8, 0.8500000000000001, 0.9, 0.9500000000000001, 1.0)\n"},"dateCreated":"2017-01-10T04:19:35+0000","dateStarted":"2017-01-10T04:26:52+0000","dateFinished":"2017-01-10T04:26:54+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:102"},{"text":"","dateUpdated":"2017-01-10T04:24:59+0000","config":{"colWidth":12,"graph":{"mode":"table","height":300,"optionOpen":false,"keys":[],"values":[],"groups":[],"scatter":{}},"enabled":true,"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"jobName":"paragraph_1484022289000_1751392567","id":"20170110-042449_834648733","dateCreated":"2017-01-10T04:24:49+0000","status":"READY","progressUpdateIntervalMs":500,"$$hashKey":"object:103"}],"name":"Feature Extraction","id":"2C5RT61C8","angularObjects":{"2BRWU4WXC:shared_process":[],"2AM1YV5CU:shared_process":[],"2AJXGMUUJ:shared_process":[],"2ANGGHHMQ:shared_process":[],"2AKK3QQXU:shared_process":[]},"config":{"looknfeel":"default"},"info":{}}